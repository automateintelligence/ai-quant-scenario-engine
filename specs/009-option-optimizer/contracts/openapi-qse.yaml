openapi: 3.1.0
info:
  title: Quant Scenario Engine API (Logical Contracts for CLI)
  version: 0.1.0
  description: >-
    Contracts mirror CLI/DSL inputs and outputs so they can be validated and
    tested even though the MVP ships as a CLI. Endpoints are logical and map to
    Typer commands.
paths:
  /runs/compare:
    post:
      summary: Run stock vs option Monte Carlo comparison
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompareRequest'
      responses:
        '200':
          description: Comparison completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunResponse'
  /runs/grid:
    post:
      summary: Execute parameter grid exploration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GridRequest'
      responses:
        '200':
          description: Grid job completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunResponse'
  /screenings:
    post:
      summary: Screen universe for candidate episodes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScreenRequest'
      responses:
        '200':
          description: Candidate list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScreenResponse'
  /runs/conditional:
    post:
      summary: Conditional backtest/Monte Carlo on candidate episodes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConditionalRequest'
      responses:
        '200':
          description: Conditional run completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunResponse'
  /runs/replay:
    post:
      summary: Replay a prior run using run_meta
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReplayRequest'
      responses:
        '200':
          description: Replayed metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunResponse'

components:
  schemas:
    CompareRequest:
      type: object
      required: [symbol, start, end, distribution, paths, steps, strategies, seed]
      properties:
        symbol:
          type: string
        start:
          type: string
          format: date
        end:
          type: string
          format: date
        distribution:
          type: string
          enum: [laplace, student_t, garch_t]
        paths:
          type: integer
          minimum: 1
        steps:
          type: integer
          minimum: 1
        seed:
          type: integer
        data_source:
          type: string
          enum: [yfinance, schwab_stub]
          default: yfinance
        option_pricer:
          type: string
          enum: [black_scholes, py_vollib, quantlib]
          default: black_scholes
        strategies:
          type: array
          minItems: 2
          items:
            $ref: '#/components/schemas/StrategyConfig'
    GridRequest:
      type: object
      required: [symbol, start, end, distribution, paths, steps, grid, seed]
      properties:
        symbol:
          type: string
        start:
          type: string
          format: date
        end:
          type: string
          format: date
        distribution:
          type: string
          enum: [laplace, student_t, garch_t]
        paths:
          type: integer
        steps:
          type: integer
        seed:
          type: integer
        data_source:
          type: string
          enum: [yfinance, schwab_stub]
        max_workers:
          type: integer
          maximum: 6
        grid:
          type: array
          items:
            $ref: '#/components/schemas/StrategyGridConfig'
    ScreenRequest:
      type: object
      required: [universe]
      properties:
        universe:
          type: array
          minItems: 1
          items:
            type: string
          description: "CSV file path or list of symbols to screen"
        strategy:
          type: string
          description: "Optional strategy name for Mode B/C. If omitted, runs Mode A (candidate selection only)"
        rank_by:
          type: string
          enum: [sharpe, mean_pnl, sortino, max_drawdown, cvar]
          default: sharpe
          description: "Metric to rank symbols by when strategy is specified"
        conditional_file:
          type: string
          description: "Optional path to YAML selector file for Mode C (conditional strategy screening)"
        selector:
          $ref: '#/components/schemas/CandidateSelector'
          description: "Inline selector for Mode A (US4) or Mode C. Mutually exclusive with conditional_file"
        lookback_years:
          type: number
          minimum: 1
          description: "Years of historical data for strategy evaluation"
        top_n:
          type: integer
          minimum: 1
          description: "Return top N ranked symbols"
        min_episodes:
          type: integer
          default: 10
          description: "Minimum episodes required per symbol for conditional screening (Mode C)"
    ScreenResponse:
      type: object
      properties:
        mode:
          type: string
          enum: [candidate_selection, unconditional_strategy, conditional_strategy]
          description: "Which screening mode was executed"
        selector_name:
          type: string
          description: "Name of selector used (Modes A and C only)"
        strategy:
          type: string
          description: "Strategy evaluated (Modes B and C only)"
        rank_by:
          type: string
          description: "Metric used for ranking (Modes B and C only)"
        candidates:
          type: array
          items:
            $ref: '#/components/schemas/CandidateEpisode'
          description: "Candidate episodes for Mode A, or ranked symbol results for Modes B/C"
        ranked_symbols:
          type: array
          items:
            $ref: '#/components/schemas/RankedSymbolResult'
          description: "Ranked symbols with strategy metrics (Modes B and C only)"
    RankedSymbolResult:
      type: object
      properties:
        symbol:
          type: string
        rank:
          type: integer
        metrics:
          $ref: '#/components/schemas/MetricsReport'
        episode_count:
          type: integer
          description: "Number of episodes evaluated (Mode C only)"
        confidence:
          type: string
          enum: [high, medium, low]
          description: "Confidence level based on episode count"
    ConditionalRequest:
      allOf:
        - $ref: '#/components/schemas/CompareRequest'
        - type: object
          required: [selector]
          properties:
            selector:
              $ref: '#/components/schemas/CandidateSelector'
            min_episodes:
              type: integer
              default: 30
    ReplayRequest:
      type: object
      required: [run_meta_path]
      properties:
        run_meta_path:
          type: string
          format: unix-path
        allow_data_drift:
          type: boolean
          default: false
    StrategyConfig:
      type: object
      required: [name, kind]
      properties:
        name:
          type: string
        kind:
          type: string
          enum: [stock, option]
        params:
          type: object
          additionalProperties: true
        sizing:
          type: string
          enum: [fixed_notional, percent_equity]
        fees:
          type: number
          minimum: 0
        slippage:
          type: number
          minimum: 0
        option_spec:
          $ref: '#/components/schemas/OptionSpec'
    StrategyGridConfig:
      type: object
      required: [name, kind, grid]
      properties:
        name:
          type: string
        kind:
          type: string
          enum: [stock, option]
        grid:
          type: object
          description: Parameter ranges keyed by param name
          additionalProperties: true
        shared:
          $ref: '#/components/schemas/StrategyConfig'
    CandidateSelector:
      type: object
      required: [name, rules]
      properties:
        name:
          type: string
        rules:
          type: array
          items:
            $ref: '#/components/schemas/SelectorRule'
        feature_requirements:
          type: array
          items:
            type: string
        min_lookback:
          type: integer
          minimum: 1
    SelectorRule:
      type: object
      required: [field, operator, value]
      properties:
        field:
          type: string
          description: e.g., gap_pct, volume_z
        operator:
          type: string
          enum: [gt, gte, lt, lte, eq, between]
        value:
          oneOf:
            - type: number
            - type: array
              items:
                type: number
    CandidateEpisode:
      type: object
      properties:
        symbol:
          type: string
        t0:
          type: string
          format: date-time
        horizon:
          type: integer
        state_features:
          type: object
          additionalProperties:
            type: number
    OptionSpec:
      type: object
      properties:
        option_type:
          type: string
          enum: [call, put]
        strike:
          oneOf:
            - type: number
            - type: string
              description: relative offset like 'atm', '+0.05'
        maturity_days:
          type: integer
        implied_vol:
          type: number
        risk_free_rate:
          type: number
        contracts:
          type: integer
    RunResponse:
      type: object
      properties:
        run_id:
          type: string
        artifacts_path:
          type: string
          format: unix-path
        metrics_path:
          type: string
        run_meta_path:
          type: string
        status:
          type: string
          enum: [queued, running, completed, failed]
        message:
          type: string
